const ElementsCollection=Backbone.Collection.extend({model:LiquidWidgetBaseModel});class LiquidApp{isStarted=!1;topWrapClassname="lqd-wrap";topWrapSelector=`#${this.topWrapClassname}`;containersClassname="e-con";containersBoxedClassname="e-con-boxed";widgetsClassname="elementor-widget";containersSelector=`.${this.containersClassname}`;containersBoxedSelector=`.${this.containersBoxedClassname}`;widgetsSelector=`.${this.widgetsClassname}`;globalBehaviors=[];layoutRegions={};elementsCollection=new ElementsCollection;behaviorsInitializeQueue=[];windowResizeUpdateQueue=[];_windowSize={width:window.innerWidth,height:window.innerHeight};_prevWindowSize=this._windowSize;globalOptions={localScroll:{offset:0,duration:1}};activeBreakpoint="";uninitializedBehaviors=[];deferredBehaviorsQueue=new Map;constructor({layoutRegions:i,containersSelector:t,widgetsSelector:e,globalOptions:n,globalBehaviors:o}){_.extend(this,Backbone.Events),_.extend(window.liquid,Backbone.Events),fastdom=fastdom.extend(fastdomPromised),i&&(this.layoutRegions=i),t&&(this.containersSelector=t),e&&(this.widgetsSelector=e),n&&(this.globalOptions={...this.globalOptions,...n}),o&&(this.globalBehaviors=[...this.globalBehaviors,...o]),this.model=new Backbone.Model({loadedBehaviors:window.liquid?.loadedBehaviors||[]}),this.view=new Backbone.View({el:"#lqd-wrap"}),this.view.model=this.model,this.model.view=this.view,this.beforeWindowResize=_.debounce(this.beforeWindowResize.bind(this),185.69),this.afterWindowResize=_.debounce(this.afterWindowResize.bind(this),585.69,!1)}get prevWindowSize(){return this._prevWindowSize}set prevWindowSize({width:i,height:t}){this._prevWindowSize={width:i,height:t}}get windowSize(){return this._windowSize}set windowSize({width:i,height:t}){this._windowSize={width:i,height:t}}start(i={isEditor:!1}){this.trigger("app:before:start",this),this.elementsCollection.comparator=(t,e)=>{this.elementsCollectionSortedCIDs||(this.elementsCollectionSortedCIDs=[...document.querySelectorAll("[data-lqd-model-cid]")].map(l=>l.getAttribute("data-lqd-model-cid")));const n=t.cid,o=e.cid;let s=0;return this.elementsCollectionSortedCIDs.indexOf(n)>this.elementsCollectionSortedCIDs.indexOf(o)?s=1:this.elementsCollectionSortedCIDs.indexOf(n)<this.elementsCollectionSortedCIDs.indexOf(o)&&(s=-1),s},this.elementsCollection.on("sort",()=>{this.elementsCollectionSortedCIDs=null}),this.topWrap=document.querySelector(this.topWrapSelector),this.setActiveBreakpoint(),Object.entries(this.layoutRegions).forEach(([t,e])=>{const n=typeof e.el=="string"?document.getElementById(e.el):e.el,o=typeof e.contentWrap=="string"?document.getElementById(e.contentWrap):e.contentWrap;this.layoutRegions[t].el=n,this.layoutRegions[t].contentWrap=o}),this.buildElementsCollection(),this.addLayoutRegions(),this.model.set({childrenCollection:this.elementsCollection}),_.defer(()=>{i.isEditor||(this.addBehaviors(),this.initializeBehaviors()),this.trigger("app:start",this)}),_.defer(()=>{this.bindWindowResize()}),_.defer(()=>{i.isEditor||(this.isStarted=!0)})}childrenComparator(i,t){const e=this.elementsCollection.map(l=>l.cid),n=i.cid,o=t.cid;let s=0;return e.indexOf(n)>e.indexOf(o)?s=1:e.indexOf(n)<e.indexOf(o)&&(s=-1),s}addLayoutRegions(){Object.entries(this.layoutRegions).forEach(([i,{el:t,contentWrap:e}])=>{const n=this.elementsCollection.where(r=>r.get("layoutRegion")===i),o=Backbone.Collection.extend({model:LiquidWidgetBaseModel}),s=new o(n),l=new LiquidBaseModel({childrenCollection:s}),a=new LiquidBaseView({model:l,contentWrap:e,el:t});s.comparator=this.childrenComparator.bind(this),l.view=a,this.layoutRegions[i]=this.layoutRegions[i]||{},this.layoutRegions[i].model=l})}buildElementsCollection(){[...document.querySelectorAll(`${this.containersSelector}, ${this.widgetsSelector}`)].forEach(t=>this.buildElementModelAndView(t))}buildElementModelAndView(i,{region:t,sort:e=!1}={}){if(i.hasAttribute("data-lqd-model-cid"))return;const n=i.classList.contains(this.containersClassname),o=t||this.getElRegion(i),s=[],l={},a=i.hasAttribute("data-lqd-has-inner-animatables"),r=new LiquidWidgetBaseModel({isContainer:n,layoutRegion:o,animatableElements:a?i.querySelectorAll("[data-lqd-inner-animatable-el]"):[i],dataId:i.getAttribute("data-id")}),c=new LiquidBaseView({model:r,el:i});r.view=c,i.setAttribute("data-lqd-model-cid",r.cid),i.setAttribute("data-lqd-view-cid",c.cid),this.elementsCollection.add(r,{sort:e});const d=this.layoutRegions[o]?.model?.get("childrenCollection");d&&d.add(r,{sort:e});let u=i.parentElement?.closest(`${this.containersSelector}, ${this.widgetsSelector}`);for(;u;)s.push(u),u=u?.parentElement?.closest(`${this.containersSelector}, ${this.widgetsSelector}`);const f=this.getModelsOfElements(s,{layoutRegion:o,sort:e});if(f.length){const h=Backbone.Collection.extend({model:LiquidWidgetBaseModel});l.parentsCollection=new h(f),l.topParentContainer=f.at(-1)}const w=[...i.querySelectorAll(`${this.containersSelector}, ${this.widgetsSelector}`)];if(w.length){const h=this.getModelsOfElements(w,{layoutRegion:o,sort:e}),m=Backbone.Collection.extend({model:LiquidWidgetBaseModel});l.childrenCollection=new m(h),l.isBoxed=i.classList.contains(this.containersBoxedClassname),l.childrenCollection.comparator=this.childrenComparator.bind(this),l.topParentContainer||(l.isTopLevelContainer=!0)}return r.set(l),l.parentsCollection&&l.parentsCollection.forEach(h=>{const m=h.get("childrenCollection");m&&m.add(r,{sort:e})}),r}getElRegion(i){const t=_.omit(this.layoutRegions,"liquidPageContent");let e="liquidPageContent";return Object.entries(t).forEach(([n,{contentWrap:o}])=>{if(o&&o.contains(i))return e=n}),e}getModelsOfElements(i=[],{layoutRegion:t,sort:e=!1}={}){let n=[];return i?.length&&(n=i.map(o=>this.elementsCollection.findWhere(s=>s.cid===o.getAttribute("data-lqd-model-cid"))||this.buildElementModelAndView(o,{layoutRegion:t,sort:e})).filter(o=>o&&o.view)),n}addToElementsCollection(i,{layoutRegion:t="liquidPageContent"}={}){this.buildElementModelAndView(i,{layoutRegion:t,sort:!0})}removeFromElementsCollection(i){if(!i)return;const t=i.getAttribute("data-lqd-model-cid"),e=this.elementsCollection.get(t);if(!e)return;this.elementsCollection.remove(e);const n=e.get("layoutRegion");this.elementsCollection.find(o=>{const s=o.get("parentsCollection"),l=o.get("childrenCollection");s?.forEach(a=>a?.get("childrenCollection")?.remove(e)),l?.remove(e)}),this.layoutRegions[n].model.get("childrenCollection").remove(e),e.view.destroy()}addBehaviors(){const i=[];this.model.on("change:loadedBehaviors",(t,e)=>{if(!this.uninitializedBehaviors.length)return;const o=e.at(-1).name,s=this.uninitializedBehaviors.filter(({behavior:l})=>l.behaviorName===o);s.forEach(({model:l,behavior:a})=>this.addElementBehaviors({model:l,behaviorsArray:[a]})),this.uninitializedBehaviors=_.difference(this.uninitializedBehaviors,s)}),[...this.elementsCollection.models].reverse().forEach(t=>{const e=t.get("dataId"),n=t.view.el,o=window.liquid.behaviors?.filter(s=>{if(s.dataId&&e)return s.dataId===e;if(s.el)return s.el===n})?.flatMap(s=>s.behaviors);o?.length&&i.push({model:t,behaviorsArray:o})}),Object.entries(this.layoutRegions).forEach(([t,{behaviors:e,model:n}])=>{e&&i.push({model:n,behaviorsArray:[...e,...window.liquid?.behaviors?.filter(o=>o.layoutRegion&&o.layoutRegion===t)?.flatMap(o=>o.behaviors)||[]]})}),this.globalBehaviors.length&&i.push({model:this.model,behaviorsArray:this.globalBehaviors}),this.constructBehaviors(i),window.liquid.behaviors=[]}addElementBehaviors({el:i,model:t,behaviorsArray:e,layoutRegion:n}){if(!i&&!t&&n||!e)return;const o=n?this.layoutRegions[n]?.model:this.elementsCollection,s=t||o?.find(l=>l.view.el===i);s&&(this.constructBehaviors([{model:s,behaviorsArray:e}]),this.initializeBehaviors())}constructBehaviors(i){[...i].sort((e,n)=>e.model.get("isContainer")-n.model.get("isContainer")).forEach(({model:e,behaviorsArray:n})=>{n.forEach(o=>{let{behaviorClass:s,behaviorName:l}=o;if(l&&!s&&(s=this.model.get("loadedBehaviors").find(d=>d.name===l)),!s||typeof s=="string")return this.uninitializedBehaviors.push({model:e,behavior:o});const a=s.initializeConditions;if(a?.length&&!a.every(d=>d))return;const r=new s(e.view,o?.options||{}),c=e.get("behaviors")||[];if(e.set({behaviors:[...c,r]}),r.willEmitInitializeTriggerEvents.length)return this.deferredBehaviorsQueue.set(e.cid,[...this.deferredBehaviorsQueue.get(e.cid)||[],r]);this.behaviorsInitializeQueue.push(r)})})}initializeBehaviors(){if(this.behaviorsInitializeQueue.forEach(i=>{i.initializeTriggers.size===0&&i.initialize(),this.behaviorsInitializeQueue=this.behaviorsInitializeQueue.filter((t,e)=>e>0)}),this.deferredBehaviorsQueue.size!==0)for(const[i,t]of this.deferredBehaviorsQueue){const e=this.elementsCollection.get(i)?.get("behaviors"),n=e?.at(0)?.model?.cid;if(e?.length===1&&n===t?.at(0)?.model?.cid)return;t.forEach(o=>o.initialize()),this.deferredBehaviorsQueue.delete(i)}}destroyElementBehaviors({el:i,model:t}={}){if(!(!i&&!t)){if(!t){const e=i.getAttribute("data-lqd-model-cid");t=this.elementsCollection.find(n=>n.cid===e)}t&&t.get("behaviors")?.forEach(e=>{e.destroy()})}}setActiveBreakpoint(){const i=liquid?.breakpoints;if(!i)return;const t=[{mm:window.matchMedia("(min-width: 1201px)"),breakpointKey:"desktop"}];Object.entries(i).forEach(([e,{direction:n,is_enabled:o,value:s}])=>{o&&t.push({mm:window.matchMedia(`(${n}-width: ${s}px)`),breakpointKey:e})}),this.activeBreakpoint=t.filter(({mm:e})=>e.matches)?.at(-1)?.breakpointKey||"desktop"}bindWindowResize(){window.addEventListener("resize",()=>{this.beforeWindowResize(),this.afterWindowResize()})}beforeWindowResize(){this.prevWindowSize=this.windowSize,this.trigger("before:windowResize",{prevSize:this.prevWindowSize,currentSize:this.windowSize})}afterWindowResize(){this.windowSize={width:window.innerWidth,height:window.innerHeight},this.setActiveBreakpoint(),this.trigger("after:windowResize",{prevSize:this.prevWindowSize,currentSize:this.windowSize})}destroy(){this.isStarted=!1,this.off(),this.stopListening(),this.layoutRegions={},this.elementsCollection=new ElementsCollection}}
