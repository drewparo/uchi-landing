class LiquidBehavior{static name="liquidBase";static initialModelProps={};static initializeConditions=[];static willEmitInitializeTriggerEvents=[];static appEvents={};static regionsEvents={};static modelEvents={};static viewEvents={};static viewModelEvents={};static parentsCollectionEvents={};static topParentContainerEvents={};static topParentChildrenCollectionEvents={};static childrenCollectionEvents={};static domEvents={};static windowEvents={};breakpointsOrder=["all",...Object.keys(window.liquid.breakpoints).filter(t=>window.liquid.breakpoints[t].is_enabled)];constructor(t,i){_.extend(this,Backbone.Events),this.model=new Backbone.Model(this.initialModelProps),this.view=t,this._ui={},this._allEvents={domEvents:[],windowEvents:[]},this._options={...this.options(),...i},this.initializeTriggers=new Set,this.isDestroyed=!1,this.liquidApp=window.liquid.app,this.preInitialize()}preInitialize(){this.addUi(),this.addAllEvents()}initialize(){}options(){return{}}get name(){return this.constructor.name}get initialModelProps(){return this.constructor.initialModelProps}get willEmitInitializeTriggerEvents(){return this.constructor.willEmitInitializeTriggerEvents}get ui(){return{}}get appEvents(){return this.constructor.appEvents}get regionsEvents(){return this.constructor.regionsEvents}get modelEvents(){return this.constructor.modelEvents}get viewEvents(){return this.constructor.viewEvents}get viewModelEvents(){return this.constructor.viewModelEvents}get parentsCollectionEvents(){return this.constructor.parentsCollectionEvents}get topParentContainerEvents(){return this.constructor.topParentContainerEvents}get topParentChildrenCollectionEvents(){return this.constructor.topParentChildrenCollectionEvents}get childrenCollectionEvents(){return this.constructor.childrenCollectionEvents}get domEvents(){return this.constructor.domEvents}get windowEvents(){return this.constructor.windowEvents}get throttledFunctions(){return{}}get debouncedFunctions(){return{}}get bindToThis(){return[]}get initializeConditions(){return this.constructor.initializeConditions}addUi(){Object.entries({...this.ui,...this.getOption("ui")||{}}).forEach(([t,i])=>{this._ui[t]=[...this.view.el.querySelectorAll(i)]})}addAllEvents(){this.bindAllEvents(),this.listenToAppEvents(),this.listenToRegionsEvents(),this.buildThrottledAndDebouncedFunctions(this.throttledFunctions,"throttle"),this.buildThrottledAndDebouncedFunctions(this.debouncedFunctions,"debounce"),this.listenToModelsAndViewEvents("parentsCollectionEvents",this.view.model.get("parentsCollection")),this.listenToModelsAndViewEvents("topParentContainerEvents",this.view.model.get("topParentContainer")||this.view.model),this.listenToModelsAndViewEvents("topParentChildrenCollectionEvents",this.view.model.get("topParentContainer")?.get("childrenCollection")||this.view.model.get("childrenCollection")),this.listenToModelsAndViewEvents("modelEvents",this.model),this.listenToModelsAndViewEvents("viewEvents",this.view),this.listenToModelsAndViewEvents("viewModelEvents",this.view.model),this.listenToModelsAndViewEvents("childrenCollectionEvents",this.view.model.get("childrenCollection")),this.addDomEvents(),this.addWindowEvents()}bindAllEvents(){this.bindToThis?.length&&_.bindAll(this,...this.bindToThis)}getChangeProp(t="openedItems"){const i=this.getOption("changePropPrefix");return i?`${t}@${i}`:t}listenToModelsAndViewEvents(t,i){if(!i)return;const e=this[t];if(!e)return;const n=Object.entries(e),s=this.view.model.get("childrenCollection");n.length&&n.forEach(([o,l])=>{const h=[];Array.isArray(l)?l.forEach(r=>{if(typeof r=="string")h.push(this.buildFunction(r,o,i));else if(typeof r=="object"){const d=Object.keys(r)[0],c=Object.values(r)[0];h.push(()=>this.listenTo(i,d,this.buildFunction(c,o,i)))}}):h.push(this.buildFunction(l,o,i)),h.filter(r=>r).forEach(r=>{if(!i?.models){const d=new Backbone.Collection;if(l.listenToChildrenToo){if(s){const c=s.where(u=>u.get("behaviors")?.find(a=>a.willEmitInitializeTriggerEvents.includes(o)));c.length&&d.add(c)}if(i?.get("behaviors")?.find(c=>c.willEmitInitializeTriggerEvents.includes(o))&&d.add(i),d.length)return r=_.after(d.length,r),this.listenTo(d,o,r);if(!this.view.model.get("behaviors")?.find(c=>c.willEmitInitializeTriggerEvents.includes(o)))return r()}}this.listenTo(i,o,r)})})}listenToAppEvents(){this.liquidApp&&Object.entries(this.appEvents).forEach(([t,i])=>{const e=this.buildFunction(i,t);e&&this.listenTo(this.liquidApp,t,e)})}listenToRegionsEvents(){this.liquidApp&&Object.entries(this.regionsEvents).forEach(([t,i])=>{const e=this.liquidApp.layoutRegions[t]?.model;e&&i.forEach(n=>{const s=Object.keys(n)[0],o=this.buildFunction(Object.values(n)[0],s);o&&this.listenTo(e,s,o)})})}addDomEvents(){this.domEvents&&Object.entries(this.domEvents).forEach(([t,i])=>{const e=t.split(" "),n=e[0],s=e[1],o=this.buildFunction(i,n);if(!o)return;let l;if(s)if(s.startsWith("@"))l=this.getUI(s.replace("@",""));else if(s.includes("<")){const h=s.replace("<","");h==="document"?l=[document]:l=document.querySelectorAll(h)}else l=this.view.el.querySelectorAll(s);else l=[this.view.el];l.forEach(h=>h.addEventListener(n,o)),this._allEvents.domEvents.push({els:l,eventType:n,fn:o})})}addWindowEvents(){this.windowEvents&&Object.entries(this.windowEvents).forEach(([t,i])=>{const e=this.buildFunction(i,t);e&&(window.addEventListener(t,e),this._allEvents.windowEvents.push({event:t,fn:e}))})}buildFunction(t,i,e){const n=t.func||t;if(!this[n])return console.warn("Could not find the handler",this,n);if(t.ifHasOption&&!this.getOption(t.ifHasOption))return!1;let s=this[n].bind(this);return t.once&&(s=_.once(s)),t.throttle?s=_.throttle(s,t.throttle.wait,{...t.throttle.options}):t.debounce&&(s=_.debounce(s,t.debounce.wait,t.debounce?.options?.immediate)),n==="initialize"&&this.initializeTriggers.add({eventName:i,modelOrView:e}),s}buildThrottledAndDebouncedFunctions(t,i){Object.entries(t).forEach(([e,n])=>{if(!this[e])return console.warn("Could not find the handler",this,e);this[e]=_[i](this[e].bind(this),n.wait,i==="throttle"?{..._.omit(n,"wait")}:n.immediate)})}getUI(t){let i=this._ui[t]||[];const e=t.split(/:|\[/);if(e.length<2)return i;const n=e[0],s=t.replace(n,"");return i=this._ui[n].filter(o=>o.matches(s)),i}getOption(t){return this._options[t]}setOption(t,i,e=!0){if(this._options[t]&&e)return this._options[t]=_.extend(this._options[t],i);this._options[t]=i}destroy(){this.handleDestroy(),this.isInitialized=!1}handleDestroy(){this.offAllEvents();const t=this.view.model.get("behaviors").filter(i=>i.model.cid!==this.model.cid);this.view.model.set({behaviors:t}),this.isDestroyed=!0}offAllEvents(){this.offDomEvents(),this.offWindowEvents(),this.model.off(),this.off(),this.stopListening()}offDomEvents(){this._allEvents.domEvents.forEach(({els:t,eventType:i,fn:e})=>t.forEach(n=>n.removeEventListener(i,e,!1)))}offWindowEvents(){this._allEvents.windowEvents.forEach(({event:t,fn:i})=>window.removeEventListener(t,i,!1))}}
