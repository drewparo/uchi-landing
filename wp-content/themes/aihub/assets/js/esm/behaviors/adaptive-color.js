"use strict";import{DATA_ATTRS as r}from"../lib/consts.js";import g from"./base.js";class n extends g{static name="liquidAdaptiveColor";static regionsEvents={liquidPageContent:[{"change:computedStyles":"initialize"}]};static windowEvents={scroll:{func:"onScroll",throttle:{wait:150,options:{leading:!0}}}};get bindToThis(){return["init","initWatch","detectCollision","onPageContentBgChange"]}get throttledFunctions(){return{onPageContentBgChange:{wait:150}}}initialize(){this.init(),this.onScroll()}init(){if(this.handleWidgetViewColorSchemeChange(),this.liquidApp.layoutRegions?.liquidPageContent?.model.get("behaviors").findIndex(t=>t.name==="liquidAdaptiveBackground")>=0)return this.listenToPageContentBgChange();this.initWatch()}handleWidgetViewColorSchemeChange(){this.view.model.on("change:colorScheme",(i,t)=>{t?this.view.el.setAttribute(r.COLOR_SCHEME.HTML_ATTR,t):this.view.el.removeAttribute(r.COLOR_SCHEME.HTML_ATTR)})}listenToPageContentBgChange(){const i=this.liquidApp.layoutRegions?.liquidPageContent?.model;i&&this.listenTo(i,"change:adaptiveBg",this.onPageContentBgChange)}onPageContentBgChange(i,{currentColor:t}){this.setWidgetModelColorScheme(this.getLuminosity(t.brightness))}initWatch(){if(!this.liquidApp.layoutRegions?.liquidPageContent)return;const i=new Backbone.Collection;this.liquidApp.layoutRegions.liquidPageContent&&i.add(this.liquidApp.layoutRegions.liquidPageContent.model?.get("childrenCollection").filter(t=>t.get("isContainer"))),this.liquidApp.layoutRegions.liquidPageFooter&&i.add(this.liquidApp.layoutRegions.liquidPageFooter.model?.get("childrenCollection").filter(t=>t.get("isContainer"))),this.pageContentContainers=i,this.scrollDirection=1,this.lastScrollPos=window.scrollY}onScroll(){this.isDestroyed||!this.pageContentContainers?.length||(this.scrollDirection=this.lastScrollPos<=window.scrollY?1:-1,this.detectCollision(),this.lastScrollPos=window.scrollY)}detectCollision(){const{scrollY:i}=window,t=this.view.model.get("rect");if(!t)return;const l=this.pageContentContainers.map(e=>{const o=e.get("rect")||{};return{cid:e.cid,rect:{...o,y:(o?.y||0)-i,bottom:(o?.bottom||0)-i}}}),s=l.filter(({rect:e})=>(this.scrollDirection>0?e.y>=t.y:e.y<=t.y)&&e.right>=t.right&&e.x<=t.x),a=l.filter(({rect:e})=>(this.scrollDirection>0?e.y<=t.y:e.y>=t.y)&&e.right>=t.right&&e.x<=t.x),d=this.scrollDirection>0?a[a.length-1]:s[s.length-1];d&&this.setWidgetModelColorScheme(this.getLuminosity(this.pageContentContainers.find(e=>e.cid===d.cid).get("brightness").backgroundColor))}getLuminosity(i){let t="light";return(!isNaN(i)&&i<=.5||i==="dark")&&(t="dark"),t}setWidgetModelColorScheme(i){fastdom.mutate(()=>this.view.model.set({colorScheme:i}))}destroy(){this.setWidgetModelColorScheme(null),super.destroy()}}window.liquid?.app?window.liquid?.app?.model?.set("loadedBehaviors",[...window.liquid.app.model.get("loadedBehaviors"),n]):window.liquid?.loadedBehaviors?.push(n);export default n;
