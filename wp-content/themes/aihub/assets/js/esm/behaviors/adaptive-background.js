"use strict";import{DATA_ATTRS as a}from"../lib/consts.js";import{getBrightness as g}from"../utils/colors.js";import c from"./base.js";class n extends c{static name="liquidAdaptiveBackground";static viewModelEvents={"change:computedStyles":"initialize"};adaptiveBgEl=null;childrenCollection=this.view.model.get("childrenCollection");colors=[];adaptiveElScrollTrigger;containersScrollTriggers=[];isInitiated=!1;options(){return{applyBrightnessOnBody:!1}}get throttledFunctions(){return{onContainerScrollTriggerUpdate:{wait:69,trailing:!0},updateColors:{wait:69,trailing:!0}}}get bindToThis(){return["buildColorsArray","createMarkup","getContainerColor","addToContainersScrollTrigger"]}async initialize(){this.isDestroyed||(this.colors=await fastdom.measure(this.buildColorsArray),await fastdom.mutate(this.createMarkup),!this.isDestroyed&&_.defer(()=>{this.isDestroyed||(this.isInitiated&&this.refreshScrollTriggers(),this.initPinAdaptiveBgEl(),this.childrenCollection.filter({isTopLevelContainer:!0}).forEach(this.addToContainersScrollTrigger),this.isInitiated=!0)}))}buildColorsArray(){return this.childrenCollection.filter({isTopLevelContainer:!0}).map(this.getContainerColor)}getContainerColor(e){const t=e.get("styles")||{},i=t?.originalBackgroundColor||t?.backgroundColor||this.view.model.get("style")?.backgroundColor;return e.view.el.style.background="none",!t?.originalBackgroundColor&&e.set({styles:{...t,originalBackgroundColor:t?.backgroundColor}}),{color:i,brightness:g(i)}}createMarkup(){if(this.isInitiated||this.isDestroyed)return;this.adaptiveBgEl=document.createElement("div");const e={width:"100%",height:"100vh",position:"absolute",top:0,left:0,backgroundColor:this.colors[0]?.color};Object.entries(e).forEach(([t,i])=>this.adaptiveBgEl.style[t]=i),this.view.el.insertBefore(this.adaptiveBgEl,this.view.contentWrap)}initPinAdaptiveBgEl(){if(this.isInitiated)return;const e=this.liquidApp.layoutRegions?.liquidPageFooter?.model?.view?.el;this.adaptiveElScrollTrigger=ScrollTrigger.create({trigger:this.adaptiveBgEl,start:"top top",end:e?"top bottom":"max",endTrigger:e||null,pin:!0})}addToContainersScrollTrigger(e,t){const i=this.colors[t],o=t===0?i:this.colors[t-1],r=gsap.timeline();r.fromTo(this.adaptiveBgEl,{background:o.color},{background:i.color}),r.progress(1,!0).progress(0,!0);const s=ScrollTrigger.create({animation:r,trigger:e.view.el,scrub:!0,start:"10% 80%",end:"-=25%",toggleActions:"play reset reverse reset",onUpdate:({direction:l,progress:d})=>this.onContainerScrollTriggerUpdate(t,d,l)});this.containersScrollTriggers.push(s)}onContainerScrollTriggerUpdate(e,t,i){if(t<=.3)return;const o=e>=0&&i>=1?e:e-1,r=this.colors[o];if(!r)return;this.updateColors(r);const s=this.getOption("applyBrightnessOnBody"),l=r.brightness<=.5?"dark":"light";s&&this.addBodyAttrs(l)}updateColors(e){this.view.model.set({adaptiveBg:{currentColor:e}})}addBodyAttrs(e){document.body.setAttribute(a.PAGE_COLOR_SCHEME.HTML_ATTR,e)}refreshScrollTriggers(){this.adaptiveElScrollTrigger?.refresh(),this.containersScrollTriggers.forEach(e=>_.defer(()=>e.kill())),this.containersScrollTriggers=[],this.childrenCollection.filter({isTopLevelContainer:!0}).forEach(this.addToContainersScrollTrigger)}destroyAdaptiveBg(){this.adaptiveElScrollTrigger?.kill(),this.containersScrollTriggers?.forEach(e=>e.kill()),this.view.model.unset("adaptiveBg"),this.containersCollection?.forEach(e=>e.view.el.style.background=""),this.adaptiveBgEl?.remove(),document.body.removeAttribute(a.PAGE_COLOR_SCHEME.HTML_ATTR)}destroy(){this.destroyAdaptiveBg(),this.isInitiated=!1,super.destroy()}}window.liquid?.app?window.liquid?.app?.model?.set("loadedBehaviors",[...window.liquid.app.model.get("loadedBehaviors"),n]):window.liquid?.loadedBehaviors?.push(n);export default n;
